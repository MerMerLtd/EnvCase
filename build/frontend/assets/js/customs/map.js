//--
let details = {
  '234jdbuw923': {
    type: 'Construction',
    image: 'http://dahanconcrete.com/wp-content/uploads/2012/11/aboutUs_1_s2.jpg',
    personInCharge: 'è”¡éŒ¦å¿ ',
    tel: '(02)8691-8573',
    latlng: '',
    address: 'æ–°åŒ—å¸‚æ³°å±±å€ä¸­æ¸¯å—è·¯310è™Ÿ1æ¨“',
    services: ['æ°´æ³¥åŠæ··å‡åœŸè£½å“è£½é€ æ¥­'],
    violations: ['2019-02-20 æœªéµè¡Œåœå·¥å‘½ä»¤ï¼Œä»åœ¨ä¸Šå€çºŒè¡Œæ“ä½œé æ‹Œæ··å‡åœŸä½œæ¥­', '2018-10-24 æœªä¾ç›¸é—œè¦å®šå–å¾—å›ºå®šæ±¡æŸ“æºæ“ä½œè¨±å¯2018-12-11 å»¢æ°£æ’æ”¾è¶…æ¨™'],
    reports: ['2018-07-01 é€ æˆç©ºæ°£æ··æ¿', '2017-06-23 é€ æˆç©ºæ°£æ··æ¿'],
    rate: 47,
  },
  '234jdajw923': {
    type: 'Construction',
    image: 'https://images.unsplash.com/photo-1516937941344-00b4e0337589?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1950&q=80',
    personInCharge: 'è¨±æ‰¿å…‰',
    tel: '(02)2968-6641',
    latlng: '',
    address: 'æ¿æ©‹å€å¤§è§€è·¯äºŒæ®µ174å··178è™Ÿ',
    services: ['çœŸç©ºé›»éç¨‹åº'],
    violations: ['2017-05-10 å¾äº‹çœŸç©ºé›»éç¨‹åºï¼Œæª¢æ¸¬çµæœç•°å‘³æ±¡æŸ“ç‰©æ¿ƒåº¦å¯¦æ¸¬å€¼ç‚º15ï¼Œè¶…éå›ºå®šæ±¡æŸ“æºç©ºæ°£æ±¡æŸ“ç‰©æ’æ”¾æ¨™æº–ï¼ˆå·¥æ¥­å€åŠè¾²æ¥­å€ä»¥å¤–åœ°å€æ¨™æº–å€¼10ï¼‰'],
    reports: ['2017-04-23 é€ æˆæƒ¡è‡­'],
    rate: 47,
  },
  '234jdhyw923': {
    type: 'Factory',
    image: 'https://images.unsplash.com/photo-1531431057391-da7a1aabd412?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1568&q=80',
    personInCharge: 'è¨±æ‰¿å…‰',
    tel: '(02)2968-6641',
    latlng: '',
    address: 'æ¿æ©‹å€å¤§è§€è·¯äºŒæ®µ174å··178è™Ÿ',
    services: ['çœŸç©ºé›»éç¨‹åº'],
    violations: ['2017-05-10 å¾äº‹çœŸç©ºé›»éç¨‹åºï¼Œæª¢æ¸¬çµæœç•°å‘³æ±¡æŸ“ç‰©æ¿ƒåº¦å¯¦æ¸¬å€¼ç‚º15ï¼Œè¶…éå›ºå®šæ±¡æŸ“æºç©ºæ°£æ±¡æŸ“ç‰©æ’æ”¾æ¨™æº–ï¼ˆå·¥æ¥­å€åŠè¾²æ¥­å€ä»¥å¤–åœ°å€æ¨™æº–å€¼10ï¼‰'],
    reports: ['2017-04-23 é€ æˆæƒ¡è‡­'],
    rate: 47,
  },
  '234jdasw923': {
    type: 'Factory',
    image: 'https://images.unsplash.com/photo-1531431057391-da7a1aabd412?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1568&q=80',
    personInCharge: 'è¨±æ‰¿å…‰',
    tel: '(02)2968-6641',
    latlng: '',
    address: 'æ¿æ©‹å€å¤§è§€è·¯äºŒæ®µ174å··178è™Ÿ',
    services: ['çœŸç©ºé›»éç¨‹åº'],
    violations: ['2017-05-10 å¾äº‹çœŸç©ºé›»éç¨‹åºï¼Œæª¢æ¸¬çµæœç•°å‘³æ±¡æŸ“ç‰©æ¿ƒåº¦å¯¦æ¸¬å€¼ç‚º15ï¼Œè¶…éå›ºå®šæ±¡æŸ“æºç©ºæ°£æ±¡æŸ“ç‰©æ’æ”¾æ¨™æº–ï¼ˆå·¥æ¥­å€åŠè¾²æ¥­å€ä»¥å¤–åœ°å€æ¨™æº–å€¼10ï¼‰'],
    reports: ['2017-04-23 é€ æˆæƒ¡è‡­'],
    rate: 47,
  },
  '234jdbuw123': {
    type: 'Restaurant',
    image: 'https://images.unsplash.com/photo-1473106235427-b7202ef5453d?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2089&q=80',
    personInCharge: 'è¨±æ‰¿å…‰',
    tel: '(02)2968-6641',
    latlng: '',
    address: 'æ¿æ©‹å€å¤§è§€è·¯äºŒæ®µ174å··178è™Ÿ',
    services: ['çœŸç©ºé›»éç¨‹åº'],
    violations: ['2017-05-10 å¾äº‹çœŸç©ºé›»éç¨‹åºï¼Œæª¢æ¸¬çµæœç•°å‘³æ±¡æŸ“ç‰©æ¿ƒåº¦å¯¦æ¸¬å€¼ç‚º15ï¼Œè¶…éå›ºå®šæ±¡æŸ“æºç©ºæ°£æ±¡æŸ“ç‰©æ’æ”¾æ¨™æº–ï¼ˆå·¥æ¥­å€åŠè¾²æ¥­å€ä»¥å¤–åœ°å€æ¨™æº–å€¼10ï¼‰'],
    reports: ['2017-04-23 é€ æˆæƒ¡è‡­'],
    rate: 47,
  },
  '234jdb0w123': {
    type: 'Restaurant',
    image: 'https://images.unsplash.com/photo-1530014708989-55a898ad9552?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1950&q=80g',
    personInCharge: 'è¨±æ‰¿å…‰',
    tel: '(02)2968-6641',
    latlng: '',
    address: 'æ¿æ©‹å€å¤§è§€è·¯äºŒæ®µ174å··178è™Ÿ',
    services: ['çœŸç©ºé›»éç¨‹åº'],
    violations: ['2017-05-10 å¾äº‹çœŸç©ºé›»éç¨‹åºï¼Œæª¢æ¸¬çµæœç•°å‘³æ±¡æŸ“ç‰©æ¿ƒåº¦å¯¦æ¸¬å€¼ç‚º15ï¼Œè¶…éå›ºå®šæ±¡æŸ“æºç©ºæ°£æ±¡æŸ“ç‰©æ’æ”¾æ¨™æº–ï¼ˆå·¥æ¥­å€åŠè¾²æ¥­å€ä»¥å¤–åœ°å€æ¨™æº–å€¼10ï¼‰'],
    reports: ['2017-04-23 é€ æˆæƒ¡è‡­'],
    rate: 47,
  },
  '234jklouw923': {
    type: 'Transportation',
    image: 'https://images.unsplash.com/photo-1468136020796-0eec5226a897?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1950&q=80',
    licensePlate: [{
      license: 'AKA - 969',
      isPolluted: true
    }, {
      license: 'YHU - 122',
      isPolluted: false
    }, {
      license: 'AYA - 293',
      isPolluted: false
    }, {
      license: 'QSX - 378',
      isPolluted: true
    }, {
      license: 'YHU - 122',
      isPolluted: false
    }, {
      license: 'AYA - 293',
      isPolluted: true
    }, {
      license: 'QSX - 378',
      isPolluted: false
    }, {
      license: 'YHU - 122',
      isPolluted: false
    }, ],
    pollutedCarOwnerInfo: [{
        license: 'AYA - 293',
        checkedDate: '2019/09/04',
        owner: 'å¼µé †ç™¼',
        contactInfo: '0981881128/ å°åŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯9è™Ÿ25F',
      },
      {
        license: 'AYA - 293',
        checkedDate: '2019/09/04',
        owner: 'å¼µé †ç™¼',
        contactInfo: '0981881128/ å°åŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯9è™Ÿ25F',
      },
      {
        license: 'AYA - 293',
        checkedDate: '2019/09/04',
        owner: 'å¼µé †ç™¼',
        contactInfo: '0981881128/ å°åŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯9è™Ÿ25F',
      },
    ],
  },
  'sasdkmskkw12': {
    type: 'Transportation',
    image: 'https://images.unsplash.com/photo-1492666918209-d0a9ea801f2f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80',
    licensePlate: [{
      license: 'AKA - 969',
      isPolluted: true
    }, {
      license: 'YHU - 122',
      isPolluted: false
    }, {
      license: 'AYA - 293',
      isPolluted: false
    }, {
      license: 'AYA - 293',
      isPolluted: true
    }, {
      license: 'QSX - 378',
      isPolluted: false
    }, {
      license: 'YHU - 122',
      isPolluted: false
    }, ],
    pollutedCarOwnerInfo: [{
        license: 'AYA - 293',
        checkedDate: '2019/09/04',
        owner: 'å¼µé †ç™¼',
        contactInfo: '0981881128/ å°åŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯9è™Ÿ25F',
      },
      {
        license: 'AYA - 293',
        checkedDate: '2019/09/04',
        owner: 'å¼µé †ç™¼',
        contactInfo: '0981881128/ å°åŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯9è™Ÿ25F',
      },
    ],
  },
}



// class
let OvalIcon = L.Icon.extend({
  options: {
    // shadowUrl: 'assets/img/icons/shadow.png',
    iconSize: [30, 30], // size of the icon
    shadowSize: [15, 15], // size of the shadow
    iconAnchor: [15, 15], // point of the icon which will correspond to marker's location
    shadowAnchor: [15, 15], // the same for the shadow
    popupAnchor: [30, 30] // point from which the popup should open relative to the iconAnchor
  }
});

let constructionIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Construction.png'
  }),
  cameraIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Camera.png'
  }),
  factoryIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Factory.png'
  }),
  restaurantIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Restaurant.png'
  }),
  selectedConstructionIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Construction_selected.png'
  }),
  selectedCameraIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Camera_selected.png'
  }),
  selectedFactoryIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Factory_selected.png'
  }),
  selectedRestaurantIcon = new OvalIcon({
    iconUrl: 'assets/img/icons/Restaurant_selected.png'
  });

// var
let lastClickIcon, iconMarkers = {},
  map = L.map('mapid').setView([25.009055, 121.464866], 11),
  marker = L.marker(map.getCenter(), {
    draggable: true,
    autoPan: true,
    opacity: 0,
  }).addTo(map),
  circle = L.circle(map.getCenter(), {
    color: '#fff00',
    fillColor: '#fff',
    fillOpacity: 0, //0.3,
    radius: 1000
  }).addTo(map),
  layerGroup = L.layerGroup().addTo(map),
  elements = {
    constructionEl: document.querySelector("#construction"),
    factoryEl: document.querySelector("#factory"),
    restaurantEl: document.querySelector("#restaurant"),
    cameraEl: document.querySelector("#camera"),
    iconMenu: document.querySelector(".icon-menu"),
    pieChart: document.querySelector(".pie-chart"),
    nameList: document.querySelector(".name-list"),
    myChart: document.getElementById('myChart').getContext('2d')
  },
  dataList;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '<a href="https://www.openstreetmap.org/">OSM</a>',
  maxZoom: 18,
}).addTo(map);

const selectedIcon = (iconMarker) => {
  if (lastClickIcon) {
    lastClickIcon['options']['isSelected'] = false;
    // iconMarkers[lastClickIcon.options.id] = {
    //   ...lastClickIcon,
    //   options: {
    //     ...lastClickIcon["options"],
    //     isSelected: false,
    //   },
    // };
    // iconMarkers[lastClickIcon.options.id] = {
    //   ...{
    //     ...iconMarkers
    //   } [lastClickIcon.options.id],
    //   options: {
    //     ...{
    //       ...{
    //         ...iconMarkers
    //       } [lastClickIcon.options.id]
    //     } ['options'],
    //     isSelected: false,
    //   },
    // };
    switchIcon(lastClickIcon);
  }
  // console.log(iconMarker);
  iconMarker['options']['isSelected'] = true;
  // console.log(iconMarker);

  // iconMarkers[iconMarker.options.id] = {
  //   ...iconMarker,
  //   options: {
  //     ...iconMarker["options"],
  //     isSelected: true
  //   }
  // }
  switchIcon(iconMarker);

  lastClickIcon = iconMarker;
  // console.log(type, evt.target);
  //++ ask backend to get the nameList by passing latlng & type
  getNameList(iconMarker.options.type, iconMarker.getLatLng());
}

const controlPannel = evt => {
  // console.log("click");
  layerGroup.clearLayers(); // https://stackoverflow.com/questions/41256026/clear-marker-layers-leaflet;
  let icon;
  // render iconMarkers on the layerGroup layer
  // 1. decide Icon Image by type
  if (dataList)
    dataList.list.forEach(data => {
      icon = ((data) => {
        // console.log(data.type);
        switch (data.type) {
          case "Factory":
            // elements.factoryEl.checked ? null : toggleUnSelectedType(elements.factoryEl);
            return factoryIcon;
          case "Transportation":
            // return elements.cameraEl.checked ? cameraIcon : null;
            // elements.cameraEl.checked ? null : toggleUnSelectedType(elements.cameraEl);
            return cameraIcon;
          case "Restaurant":
            // return elements.restaurantEl.checked ? restaurantIcon : null;
            // elements.restaurantEl.checked ? null : toggleUnSelectedType(elements.restaurantEl);
            return restaurantIcon;
          case "Construction":
            // return elements.constructionEl.checked ? constructionIcon : null;
            // elements.constructionEl.checked ? null : toggleUnSelectedType(elements.constructionEl);
            return constructionIcon;
          default:
        }
      })(data);
      // console.log(icon);
      if (icon) {
        iconMarkers[data.id] =
          L.marker(data.latlng, {
            icon: icon,
            id: data.id,
            isSelected: false,
            type: data.type,
          }).addTo(layerGroup).on("click", evt => {
            // console.log(evt.target === iconMarkers[evt.target.options.id]);
            selectedIcon(evt.target);
          }); //evt => selectedIcon(evt)
        // ++ control heatmap
        // (if icon !== null => that type of pollute is selected )
      }
    });
  toggleUnSelectedType();
}

const getDetails = async selectedId => {
  Array.from(elements.nameList.children).forEach(el => el.style.color = "#fff");
  // console.log(selectedId);
  document.querySelector(`[data-id='${selectedId}']`).style.color = "yellow";
  // xhr request
  let err, data;
  const opts = {
    contentType: 'application/json',
    method: "GET",
    url: "/details",
    payload: {
      "selectedId": selectedId,
    }
  };
  // [err, data] = await to(makeRequest(opts));
  if (err) throw new Error(err);
  // dummy data  
  data = {
    ...details[selectedId],
    latlng: iconMarkers[selectedId].getLatLng()
  };
  if (data) { //++ will need to remove ! later
    // call websokect;
    websocket.send(
      JSON.stringify({
        // event: elements.nameList.dataset.type === "Transportation" ? "renderTransportationDetail" : "renderCompanyDetails",
        event: data.type === "Transportation" ? "renderTransportationDetail" : "renderCompanyDetails",
        data: data,
      })
    );
    // render data to the second view.
  };
}

const onMarkerMoveStart = _ => {
  circle.setStyle({
    color: '#fff00',
    fillOpacity: 0,
    radius: 0
  });
  layerGroup.clearLayers(); // https://stackoverflow.com/questions/41256026/clear-marker-layers-leaflet
  // console.log("I am expired");
}

//--

const createHeatmapData = gross => {
  let points = [];
  for (; gross > 0; gross--) {
    points.push([
      Math.random() > 0.5 ? 25.009055 + Math.random() * 2.5 : 25.009055 - Math.random() * 2.5,
      Math.random() > 0.5 ? 121.464866 + Math.random() * 1.5 : 121.464866 - Math.random() * 1.5,
      10000 * Math.random()
    ]);
  }
  return points;
}

var heat = L.heatLayer(createHeatmapData(50), {
  radius: 10,

}).addTo(map);
//     draw = true;
// map.on({
//     movestart: function () { draw = false; },
//     moveend:   function () { draw = true; },
//     mousemove: function (e) {
//         if (draw) {
//             heat.addLatLng(e.latlng);
//         }
//     }
// })
//--

const onMarkerMoveEnd = async _ => {
  //-- 
  let num = 100;
  circle.setLatLng(marker.getLatLng());
  circle.setStyle({
    color: '#fff',
    fillOpacity: 0.3,
  });
  map.setView(marker.getLatLng(), 14);
  marker.bindPopup(`You clicked the map at ${marker.getLatLng().toString()}`).openPopup();
  setTimeout(_ => marker.closePopup(), 1000);
  // å‘¼å«APIï¼Œå›å‚³é™„è¿‘ï¼ˆæ–¹åœ“ï¼Ÿï¼Ÿï¼‰ç‡Ÿå»ºã€é¤é£²ã€å·¥å» ã€è·¯è‚©æ”å½±æ©Ÿçš„åæ¨™
  let err, data;
  const opts = {
    contentType: 'application/json',
    method: "GET",
    url: `/datalist?lat=${marker.getLatLng().lat}&lng=${marker.getLatLng().lng}&radius=1000`,
    // payload: 
  };
  // [err, data] = await to(makeRequest(opts));
  if (err) throw new Error(err);
  if (data) {
    // dataList = data
  }
  // dummy data
  // æŠŠè³‡æ–™å­˜åœ¨æœ€å¤–é¢
  dataList = {
    list: [{
        id: "234jdbuw923",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * 0.0075,
          lng: marker.getLatLng().lng + Math.random() * 0.0075,
        },
        type: "Construction",
        name: "å¤§æ¼¢é æ‹Œå» è‚¡ä»½æœ‰é™å…¬å¸",
      },
      {
        id: "234jdajw923",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * 0.0075,
          lng: marker.getLatLng().lng + Math.random() * 0.0075,
        },
        type: "Construction",
        name: "æ¼¢é¼å»ºè¨­è‚¡ä»½æœ‰é™å…¬å¸",
      }, {
        id: "234jdhyw923",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * -0.0075,
          lng: marker.getLatLng().lng + Math.random() * 0.0075,
        },
        type: "Factory",
        name: "å®ç©çœŸç©ºéé‡‘è‚¡ä»½æœ‰é™å…¬å¸",
      },
      {
        id: "234jdasw923",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * -0.0075,
          lng: marker.getLatLng().lng + Math.random() * 0.0075,
        },
        type: "Factory",
        name: "ç©é«”é›»è·¯è‚¡ä»½æœ‰é™å…¬å¸",
      }, {
        id: "234jdbuw123",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * 0.0075,
          lng: marker.getLatLng().lng + Math.random() * -0.0075,
        },
        type: "Restaurant",
        name: "çå¥½å‘³å°åƒåº—",
      },
      {
        id: "234jdb0w123",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * 0.0075,
          lng: marker.getLatLng().lng + Math.random() * -0.0075,
        },
        type: "Restaurant",
        name: "å»Ÿå£é´¨è‚‰é£¯",
      }, {
        id: "234jklouw923",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * -0.0075,
          lng: marker.getLatLng().lng + Math.random() * -0.0075,
        },
        type: "Transportation",
        name: "æ©‹ä¸­äºŒè¡—è¡—å£",
      }, {
        id: "sasdkmskkw12",
        latlng: {
          lat: marker.getLatLng().lat + Math.random() * -0.0075,
          lng: marker.getLatLng().lng + Math.random() * -0.0075,
        },
        type: "Transportation",
        name: "æ–°åŒ—å¸‚ç’°ä¿å±€è¡—å£",
      },
    ],
    pollutionRatio: {
      Construction: num -= Math.round(Math.random() * 30),
      Factory: num -= Math.round(Math.random() * 25),
      Restaurant: num -= Math.round(Math.random() * 25),
      Transportation: num -= Math.round(Math.random() * 15),
      Other: num -= Math.round(Math.random() * 5),
    },
    other: {
      note: "é‚„æœ‰ä¸€éƒ¨ä»½æ±¡æŸ“æ¨æ–·æ˜¯ä¾†è‡³å…¶ä»–ç·šä¸Šï¼Œè«‹åƒè€ƒç©ºæ°£ç¶²çš„å¤§æ°£æµå‹•æ¨¡æ“¬åœ–"
    },
  }
  // UI - æ ¹æ“šåæ¨™ render company åˆ°åœ°åœ–ä¸Š
  controlPannel(dataList);
  console.log(dataList);
  return dataList;

  // 6. åœ¨åœ°åœ–ä¸ŠåŠ ä¸ŠåŠŸèƒ½é¸å–® - é»é¸PM2.5æ±¡æŸ“æºåˆ†æåœ“é¤…åœ–ä¸Šçš„ç§»å‹•æ±¡æŸ“æºï¼ˆå¸¶å…¥åƒæ•¸å‘¼å«APIï¼‰å‰¯: å‘ˆç¾å¯¦æ™‚çš„ç›£è¦–å™¨ç•«é¢ï¼ˆé‚„æœªç¢ºå®šä¾†æº)
}

const renderNameListItem = data => {
  // console.log(data);
  const markup = `<li class="name-list__item" data-id = ${data.id} data-latlng = ${data.latlng.lat}_${data.latlng.lng}>
  ${data.name}
</li>`
  elements.nameList.insertAdjacentHTML("beforeend", markup);
  // if (iconMarkers[data.id].options.isSelected) document.querySelector(`[data-id='${data.id}']`).style.color = "yellow";
  // if (iconMarkers[data.id].options.alt) getDetails(data.id);
}

const getNameList = async (type, selectedIconCoordinate) => {
  elements.nameList.classList.add('display');
  if (elements.nameList.classList.contains('not-display'))
    elements.nameList.classList.remove('not-display');
  elements.nameList.innerHTML = '';
  elements.nameList.dataset.type = type;
  if (type === "Other") {
    const markup = `<li class="name-list__item" data-id = other >
    ${dataList.other.note}
  </li>`
    elements.nameList.insertAdjacentHTML("beforeend", markup)
    return;
  }
  dataList.list.forEach(data => {
    if (data.type === type)
      renderNameListItem(data);
  });
  if (selectedIconCoordinate) {
    // make another request to get the shop detail and render to the second view.
    // ?? why let is not working but var is?
    var selectedId = dataList.list.filter(data => data.type === type).find(data => data.latlng.lat === selectedIconCoordinate.lat && data.latlng.lng === selectedIconCoordinate.lng).id; // !== will be changed to === ++
    // console.log(selectedId);
    getDetails(selectedId);
    // select main view nameList Pannel item
  }
};


const selectNameListItem = evt => {
  // console.log(evt);
  if (evt.target.matches("li, .name-list__item")) {
    // console.log(evt.target.dataset.id);
    // console.log(evt.target.dataset.latlng.split("_").map(data => parseFloat(data)));
    // lastClickIcon = iconMarkers[evt.target.dataset.id];
    selectedIcon(iconMarkers[evt.target.dataset.id]);
    getDetails(evt.target.dataset.id);
  }
}

const openNameListPannel = type => {
  switch (type) {
    case "Factory":
      getNameList("Factory");
      break;
    case "Construction":
      getNameList("Construction");
      break;
    case "Restaurant":
      getNameList("Restaurant");
      break;
    case "Transportation": // ++ change
      getNameList("Transportation");
      break;
    case "Other":
      getNameList("Other");
      break;
  }
}

const toggleUnSelectedType = () => {
  // console.log(evt.target.checked, elements.nameList.dataset.type);
  // console.log(evt.target.dataset.type);
  // let el = evt.target ? evt.target : evt;
  Array.from(elements.iconMenu.children).forEach(el => {
    // console.log(el.firstElementChild.checked);
    if (el.firstElementChild.checked) {
      // console.log("true");
      Object.values(iconMarkers).filter(iconMarker => iconMarker.options.type === el.firstElementChild.dataset.type).forEach(iconMarker => {
        // console.log(iconMarker.options.type, el.firstElementChild.dataset.type);
        iconMarker._icon.classList.remove("not-display");
        iconMarker._icon.classList.add("display");
        // unSelectIcon
        iconMarker['options']['isSelected'] = false;
        switchIcon(iconMarker);
        document.querySelector(`[data-id='${iconMarker.options.id}']`) ? document.querySelector(`[data-id='${iconMarker.options.id}']`).style.color = "white" : null;
      });
      if (el.firstElementChild.dataset.type === elements.nameList.dataset.type) {
        elements.nameList.classList.add('display');
        elements.nameList.classList.remove('not-display');
      }
    } else {
      // console.log(false);
      Object.values(iconMarkers).filter(iconMarker => iconMarker.options.type === el.firstElementChild.dataset.type).forEach(iconMarker => {
        iconMarker._icon.classList.remove("display");
        iconMarker._icon.classList.add("not-display");
      });
      if (el.firstElementChild.dataset.type === elements.nameList.dataset.type) {
        elements.nameList.classList.remove('display');
        elements.nameList.classList.add('not-display');
      }

    }
    // let unSelectedIconMarkers = Object.values(iconMarkers).filter(iconMarker => iconMarker.type === elements.nameList.dataset.type);
    // console.log(unSelectedIconMarkers);
    // console.log(evt.target.checked && elements.nameList.dataset.type);
    // if (elements.nameList.classList.contains('display') && !evt.target.checked) {
    //   elements.nameList.classList.remove('display');

    // }
    // if (elements.nameList.dataset.type === evt.target.dataset.type && !evt.target.checked)
    //   elements.nameList.classList.add('not-display');
    // if (evt.target.checked && elements.nameList.dataset.type) {
    //   elements.nameList.classList.remove('not-display');
    //   elements.nameList.classList.add('display');
    // }

  });
}

const getLabelTag = type => {
  switch (type) {
    case 'Construction':
      return 'ç‡Ÿå»ºæ¥­';
    case 'Factory':
      return 'å·¥å» ';
    case 'Restaurant':
      return 'é¤é£²æ¥­';
    case 'Transportation':
      return 'ç§»å‹•æ±¡æŸ“æº';
    default:
      return 'å…¶ä»–';
  }
}
// ++ add arguments, like pollute type and need to fetch or get new dataList to draw pieChart
const renderPieChart = _ => {
  if(elements.pieChartTitle)
  elements.pieChart.removeChild(elements.pieChartTitle) //--
  // console.log(dataList);
  let pieChart = new Chart(elements.myChart, {
    type: 'pie',
    data: {
      labels: Object.keys(dataList.pollutionRatio),
      datasets: [{
        //é è¨­è³‡æ–™
        data: Object.values(dataList.pollutionRatio),
        backgroundColor: [
          //è³‡æ–™é¡è‰²
          "#70D49D",
          "#5599FF",
          "#FFFF77",
          "#FF8888",
          "#7B7B7B"
        ],
      }],
    },
    options: {
      // https://www.chartjs.org/docs/latest/configuration/legend.html

      onClick: function (evt) {
        let ci = this.chart;
        if (ci.getElementAtEvent(evt)[0]) {
          // https://www.chartjs.org/docs/latest/developers/api.html#getelementatevente
          openNameListPannel(Object.keys(dataList.pollutionRatio)[pieChart.getElementAtEvent(evt)[0]._index]);
        }
      },
      animation: {
        animateScale: true,
        animateRotate: true
      },
      // é—œæ–¼æ»‘éå¾Œçš„ é¡¯ç¤º
      tooltips: {
        callbacks: {
          label: function (tooltipItem, data) {
            var dataset = data.datasets[tooltipItem.datasetIndex];
            //è¨ˆç®—ç¸½å’Œ
            var sum = dataset.data.reduce(function (previousValue, currentValue, currentIndex, array) {
              return previousValue + currentValue;
            });
            var currentValue = dataset.data[tooltipItem.index];
            var percent = Math.round(((currentValue / sum) * 100));
            return " " + data.labels[tooltipItem.index] + ": " + percent + "%";
          }
        }
      },

      //æç¤ºé …ç›®çš„è™•ç†
      legend: {
        display: true,
        position: 'left',
        labels: {
          fontColor: "#fff",
          generateLabels: function (chart) {
            var data = chart.data;
            if (data.labels.length && data.datasets.length) {
              console.log(data.datasets[0], chart.getDatasetMeta(0).data);
              return data.labels.map(function (label, i) {
                var ds = data.datasets[0];
                var arc = chart.getDatasetMeta(0).data[i];
                var custom = arc && arc.custom || {};
                var getValueAtIndexOrDefault = Chart.helpers.getValueAtIndexOrDefault;
                var arcOpts = chart.options.elements.arc;
                var fill = custom.backgroundColor ? custom.backgroundColor : getValueAtIndexOrDefault(ds.backgroundColor, i, arcOpts.backgroundColor);
                var stroke = custom.borderColor ? custom.borderColor : getValueAtIndexOrDefault(ds.borderColor, i, arcOpts.borderColor);
                var bw = custom.borderWidth ? custom.borderWidth : getValueAtIndexOrDefault(ds.borderWidth, i, arcOpts.borderWidth);

                var value = chart.config.data.datasets[chart.getDatasetMeta(0).data[i]._datasetIndex].data[chart.getDatasetMeta(0).data[i]._index];
                // console.log(chart.config.data.datasets[chart.getDatasetMeta(0).data[i]._datasetIndex]);
                return {
                  text: getLabelTag(label), //label + ": " + value + "%",
                  fillStyle: fill,
                  strokeStyle: stroke,
                  lineWidth: bw,
                  hidden: isNaN(ds.data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                  index: i
                };
              });
            } else {
              return [];
            }
          }
        },
        onClick: function (evt, legendItem) {
          // console.log(evt, legendItem);
          openNameListPannel(Object.keys(dataList.pollutionRatio)[legendItem.index]);
        },
        //https://codepen.io/jordanwillis/pen/BWKKKo 
        //ğŸ‘† That looks legit, but mine is not working
        onHover: function (evt, legendItem) {
          document.getElementById("myChart").style.cursor = 'pointer';
        },
      }
    },
  });
  const markup = ` <p class="pie-chart__title">PM2.5 æ±¡æŸ“åŸåˆ†æ</p>`;
  elements.pieChart.insertAdjacentHTML('afterbegin', markup);
  // elements.pieChart.classList.remove('not-display');
  elements.pieChart.style.backgroundColor = "#000000c0";
  elements.pieChart.style.display = "block";
  elements = {
    ...elements,
    pieChartTitle: document.querySelector('.pie-chart__title')
  };
  multiElsAddListener([elements.pieChartTitle], 'click', evt => {
    evt.target.style.color = '#ffc100';
    renderPieChart();
  });

}

const onMapClick = evt => {
  // 1. get marker latlng
  marker.setOpacity(1);
  marker.setLatLng(evt.latlng); //.update()
  // 2. å–å¾—é™„è¿‘ï¼ˆæ–¹åœ“ï¼Ÿï¼Ÿï¼Œåœ¨æœ€ä¸€é–‹å§‹å°±è¨­å®šäº†ï¼Œç¾åœ¨ä¸å¯æ›´æ”¹ // ++ ï¼‰ç‡Ÿå»ºã€é¤é£²ã€å·¥å» ã€è·¯è‚©æ”å½±æ©Ÿçš„åæ¨™ï¼Œä¸¦ç•«åˆ°ç•«é¢ä¸Š
  onMarkerMoveEnd();
  // 3. åœ¨åœ°åœ–ä¸ŠåŠ ä¸ŠåŠŸèƒ½é¸å–® - é¡¯ç¤ºæ§åˆ¶è©²å€å¡Šé¡åˆ¥çš„checkbox list
  elements.iconMenu.style.display = "block";
  // 4. åœ¨åœ°åœ–ä¸ŠåŠ ä¸ŠåŠŸèƒ½é¸å–® -  è·³å‡ºPM2.5æ±¡æŸ“æºåˆ†æè³‡æ–™ï¼ˆå¸¶å…¥åæ¨™å‘¼å«APIï¼‰
  renderPieChart();
  // http://no2don.blogspot.com/2018/07/javascript-chartjs-pie-chart.html

}

addMultiListener(["movestart, dragstart, move, drag"], marker, onMarkerMoveStart);
addMultiListener(["moveend, dragend"], marker, onMarkerMoveEnd);
multiElsAddListener([elements.nameList], "click", selectNameListItem);
multiElsAddListener([elements.constructionEl, elements.cameraEl, elements.factoryEl, elements.restaurantEl], "click", toggleUnSelectedType);

map.on("click", onMapClick);