//--
let details = {
    '234jdbuw923': {
        type: 'Construction',
        image: 'http://dahanconcrete.com/wp-content/uploads/2012/11/aboutUs_1_s2.jpg',
        personInCharge: 'Ëî°Èå¶Âø†',
        tel: '(02)8691-8573',
        latlng: '',
        address: 'Êñ∞ÂåóÂ∏ÇÊ≥∞Â±±ÂçÄ‰∏≠Ê∏ØÂçóË∑Ø310Ëôü1Ê®ì',
        services: ['Ê∞¥Ê≥•ÂèäÊ∑∑ÂáùÂúüË£ΩÂìÅË£ΩÈÄ†Ê•≠'],
        violations: ['2019-02-20 Êú™ÈÅµË°åÂÅúÂ∑•ÂëΩ‰ª§Ôºå‰ªçÂú®‰∏äÂùÄÁ∫åË°åÊìç‰ΩúÈ†êÊãåÊ∑∑ÂáùÂúü‰ΩúÊ•≠', '2018-10-24 Êú™‰æùÁõ∏ÈóúË¶èÂÆöÂèñÂæóÂõ∫ÂÆöÊ±°ÊüìÊ∫êÊìç‰ΩúË®±ÂèØ2018-12-11 Âª¢Ê∞£ÊéíÊîæË∂ÖÊ®ô'],
        reports: ['2018-07-01 ÈÄ†ÊàêÁ©∫Ê∞£Ê∑∑ÊøÅ', '2017-06-23 ÈÄ†ÊàêÁ©∫Ê∞£Ê∑∑ÊøÅ'],
        rate: 47,
    },
    '234jdajw923': {
        type: 'Construction',
        image: 'https://images.unsplash.com/photo-1516937941344-00b4e0337589?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1950&q=80',
        personInCharge: 'Ë®±ÊâøÂÖâ',
        tel: '(02)2968-6641',
        latlng: '',
        address: 'ÊùøÊ©ãÂçÄÂ§ßËßÄË∑Ø‰∫åÊÆµ174Â∑∑178Ëôü',
        services: ['ÁúüÁ©∫ÈõªÈççÁ®ãÂ∫è'],
        violations: ['2017-05-10 Âæû‰∫ãÁúüÁ©∫ÈõªÈççÁ®ãÂ∫èÔºåÊ™¢Ê∏¨ÁµêÊûúÁï∞Âë≥Ê±°ÊüìÁâ©ÊøÉÂ∫¶ÂØ¶Ê∏¨ÂÄºÁÇ∫15ÔºåË∂ÖÈÅéÂõ∫ÂÆöÊ±°ÊüìÊ∫êÁ©∫Ê∞£Ê±°ÊüìÁâ©ÊéíÊîæÊ®ôÊ∫ñÔºàÂ∑•Ê•≠ÂçÄÂèäËæ≤Ê•≠ÂçÄ‰ª•Â§ñÂú∞ÂçÄÊ®ôÊ∫ñÂÄº10Ôºâ'],
        reports: ['2017-04-23 ÈÄ†ÊàêÊÉ°Ëá≠'],
        rate: 47,
    },
    '234jdhyw923': {
        type: 'Factory',
        image: 'https://images.unsplash.com/photo-1531431057391-da7a1aabd412?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1568&q=80',
        personInCharge: 'Ë®±ÊâøÂÖâ',
        tel: '(02)2968-6641',
        latlng: '',
        address: 'ÊùøÊ©ãÂçÄÂ§ßËßÄË∑Ø‰∫åÊÆµ174Â∑∑178Ëôü',
        services: ['ÁúüÁ©∫ÈõªÈççÁ®ãÂ∫è'],
        violations: ['2017-05-10 Âæû‰∫ãÁúüÁ©∫ÈõªÈççÁ®ãÂ∫èÔºåÊ™¢Ê∏¨ÁµêÊûúÁï∞Âë≥Ê±°ÊüìÁâ©ÊøÉÂ∫¶ÂØ¶Ê∏¨ÂÄºÁÇ∫15ÔºåË∂ÖÈÅéÂõ∫ÂÆöÊ±°ÊüìÊ∫êÁ©∫Ê∞£Ê±°ÊüìÁâ©ÊéíÊîæÊ®ôÊ∫ñÔºàÂ∑•Ê•≠ÂçÄÂèäËæ≤Ê•≠ÂçÄ‰ª•Â§ñÂú∞ÂçÄÊ®ôÊ∫ñÂÄº10Ôºâ'],
        reports: ['2017-04-23 ÈÄ†ÊàêÊÉ°Ëá≠'],
        rate: 47,
    },
    '234jdasw923': {
        type: 'Factory',
        image: 'https://images.unsplash.com/photo-1531431057391-da7a1aabd412?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1568&q=80',
        personInCharge: 'Ë®±ÊâøÂÖâ',
        tel: '(02)2968-6641',
        latlng: '',
        address: 'ÊùøÊ©ãÂçÄÂ§ßËßÄË∑Ø‰∫åÊÆµ174Â∑∑178Ëôü',
        services: ['ÁúüÁ©∫ÈõªÈççÁ®ãÂ∫è'],
        violations: ['2017-05-10 Âæû‰∫ãÁúüÁ©∫ÈõªÈççÁ®ãÂ∫èÔºåÊ™¢Ê∏¨ÁµêÊûúÁï∞Âë≥Ê±°ÊüìÁâ©ÊøÉÂ∫¶ÂØ¶Ê∏¨ÂÄºÁÇ∫15ÔºåË∂ÖÈÅéÂõ∫ÂÆöÊ±°ÊüìÊ∫êÁ©∫Ê∞£Ê±°ÊüìÁâ©ÊéíÊîæÊ®ôÊ∫ñÔºàÂ∑•Ê•≠ÂçÄÂèäËæ≤Ê•≠ÂçÄ‰ª•Â§ñÂú∞ÂçÄÊ®ôÊ∫ñÂÄº10Ôºâ'],
        reports: ['2017-04-23 ÈÄ†ÊàêÊÉ°Ëá≠'],
        rate: 47,
    },
    '234jdbuw123': {
        type: 'Restaurant',
        image: 'https://images.unsplash.com/photo-1473106235427-b7202ef5453d?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=2089&q=80',
        personInCharge: 'Ë®±ÊâøÂÖâ',
        tel: '(02)2968-6641',
        latlng: '',
        address: 'ÊùøÊ©ãÂçÄÂ§ßËßÄË∑Ø‰∫åÊÆµ174Â∑∑178Ëôü',
        services: ['ÁúüÁ©∫ÈõªÈççÁ®ãÂ∫è'],
        violations: ['2017-05-10 Âæû‰∫ãÁúüÁ©∫ÈõªÈççÁ®ãÂ∫èÔºåÊ™¢Ê∏¨ÁµêÊûúÁï∞Âë≥Ê±°ÊüìÁâ©ÊøÉÂ∫¶ÂØ¶Ê∏¨ÂÄºÁÇ∫15ÔºåË∂ÖÈÅéÂõ∫ÂÆöÊ±°ÊüìÊ∫êÁ©∫Ê∞£Ê±°ÊüìÁâ©ÊéíÊîæÊ®ôÊ∫ñÔºàÂ∑•Ê•≠ÂçÄÂèäËæ≤Ê•≠ÂçÄ‰ª•Â§ñÂú∞ÂçÄÊ®ôÊ∫ñÂÄº10Ôºâ'],
        reports: ['2017-04-23 ÈÄ†ÊàêÊÉ°Ëá≠'],
        rate: 47,
    },
    '234jdb0w123': {
        type: 'Restaurant',
        image: 'https://images.unsplash.com/photo-1530014708989-55a898ad9552?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1950&q=80g',
        personInCharge: 'Ë®±ÊâøÂÖâ',
        tel: '(02)2968-6641',
        latlng: '',
        address: 'ÊùøÊ©ãÂçÄÂ§ßËßÄË∑Ø‰∫åÊÆµ174Â∑∑178Ëôü',
        services: ['ÁúüÁ©∫ÈõªÈççÁ®ãÂ∫è'],
        violations: ['2017-05-10 Âæû‰∫ãÁúüÁ©∫ÈõªÈççÁ®ãÂ∫èÔºåÊ™¢Ê∏¨ÁµêÊûúÁï∞Âë≥Ê±°ÊüìÁâ©ÊøÉÂ∫¶ÂØ¶Ê∏¨ÂÄºÁÇ∫15ÔºåË∂ÖÈÅéÂõ∫ÂÆöÊ±°ÊüìÊ∫êÁ©∫Ê∞£Ê±°ÊüìÁâ©ÊéíÊîæÊ®ôÊ∫ñÔºàÂ∑•Ê•≠ÂçÄÂèäËæ≤Ê•≠ÂçÄ‰ª•Â§ñÂú∞ÂçÄÊ®ôÊ∫ñÂÄº10Ôºâ'],
        reports: ['2017-04-23 ÈÄ†ÊàêÊÉ°Ëá≠'],
        rate: 47,
    },
    '234jklouw923': {
        type: 'Transportation',
        image: 'https://images.unsplash.com/photo-1468136020796-0eec5226a897?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1950&q=80',
        licensePlate: [{
            license: 'AKA - 969',
            isPolluted: true
        }, {
            license: 'YHU - 122',
            isPolluted: false
        }, {
            license: 'AYA - 293',
            isPolluted: false
        }, {
            license: 'QSX - 378',
            isPolluted: true
        }, {
            license: 'YHU - 122',
            isPolluted: false
        }, {
            license: 'AYA - 293',
            isPolluted: true
        }, {
            license: 'QSX - 378',
            isPolluted: false
        }, {
            license: 'YHU - 122',
            isPolluted: false
        }, ],
        pollutedCarOwnerInfo: [{
                license: 'AYA - 293',
                checkedDate: '2019/09/04',
                owner: 'ÂºµÈ†ÜÁôº',
                contactInfo: '0981881128/ Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄÊùæÈ´òË∑Ø9Ëôü25F',
            },
            {
                license: 'AYA - 293',
                checkedDate: '2019/09/04',
                owner: 'ÂºµÈ†ÜÁôº',
                contactInfo: '0981881128/ Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄÊùæÈ´òË∑Ø9Ëôü25F',
            },
            {
                license: 'AYA - 293',
                checkedDate: '2019/09/04',
                owner: 'ÂºµÈ†ÜÁôº',
                contactInfo: '0981881128/ Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄÊùæÈ´òË∑Ø9Ëôü25F',
            },
        ],
    },
    'sasdkmskkw12': {
        type: 'Transportation',
        image: 'https://images.unsplash.com/photo-1492666918209-d0a9ea801f2f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80',
        licensePlate: [{
            license: 'AKA - 969',
            isPolluted: true
        }, {
            license: 'YHU - 122',
            isPolluted: false
        }, {
            license: 'AYA - 293',
            isPolluted: false
        }, {
            license: 'AYA - 293',
            isPolluted: true
        }, {
            license: 'QSX - 378',
            isPolluted: false
        }, {
            license: 'YHU - 122',
            isPolluted: false
        }, ],
        pollutedCarOwnerInfo: [{
                license: 'AYA - 293',
                checkedDate: '2019/09/04',
                owner: 'ÂºµÈ†ÜÁôº',
                contactInfo: '0981881128/ Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄÊùæÈ´òË∑Ø9Ëôü25F',
            },
            {
                license: 'AYA - 293',
                checkedDate: '2019/09/04',
                owner: 'ÂºµÈ†ÜÁôº',
                contactInfo: '0981881128/ Âè∞ÂåóÂ∏Ç‰ø°Áæ©ÂçÄÊùæÈ´òË∑Ø9Ëôü25F',
            },
        ],
    },
}



// class
let OvalIcon = L.Icon.extend({
    options: {
        // shadowUrl: 'assets/img/icons/shadow.png',
        iconSize: [30, 30], // size of the icon
        shadowSize: [15, 15], // size of the shadow
        iconAnchor: [15, 15], // point of the icon which will correspond to marker's location
        shadowAnchor: [15, 15], // the same for the shadow
        popupAnchor: [30, 30] // point from which the popup should open relative to the iconAnchor
    }
});

let constructionIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Construction.png'
    }),
    cameraIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Camera.png'
    }),
    factoryIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Factory.png'
    }),
    restaurantIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Restaurant.png'
    }),
    selectedConstructionIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Construction_selected.png'
    }),
    selectedCameraIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Camera_selected.png'
    }),
    selectedFactoryIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Factory_selected.png'
    }),
    selectedRestaurantIcon = new OvalIcon({
        iconUrl: 'assets/img/icons/Restaurant_selected.png'
    });

// var
let lastClickIcon, iconMarkers = {},
    map = L.map('mapid').setView([25.009055, 121.464866], 11),
    marker = L.marker(map.getCenter(), {
        draggable: true,
        autoPan: true,
        opacity: 0,
    }).addTo(map),
    circle = L.circle(map.getCenter(), {
        color: '#fff00',
        fillColor: '#fff',
        fillOpacity: 0, //0.3,
        radius: 1000
    }).addTo(map),
    layerGroup = L.layerGroup().addTo(map),
    elements = {
        constructionEl: document.querySelector("#construction"),
        factoryEl: document.querySelector("#factory"),
        restaurantEl: document.querySelector("#restaurant"),
        cameraEl: document.querySelector("#camera"),
        iconMenu: document.querySelector(".icon-menu"),
        pieChart: document.querySelector(".pie-chart"),
        nameList: document.querySelector(".name-list"),
        myChart: document.getElementById('myChart').getContext('2d'),
        fileInput: document.querySelector('#excel-file'),
    },
    dataList, coordinates, heatmapData;


const addMultiListener = (evts, el, func) => evts.forEach(evt => el.on(evt, func));
const multiElsAddListener = (els, evt, func) => els.forEach(el => el.addEventListener(evt, func, false));
// polyfill for Element.closest from MDN
if (!Element.prototype.matches)
    Element.prototype.matches = Element.prototype.msMatchesSelector ||
    Element.prototype.webkitMatchesSelector;

if (!Element.prototype.closest)
    Element.prototype.closest = function (s) {
        var el = this;
        if (!document.documentElement.contains(el)) return null;
        do {
            if (el.matches(s)) return el;
            el = el.parentElement;
        } while (el !== null);
        return null;
    };

// XHR
const to = promise => {
    return promise.then(data => {
            return [null, data];
        })
        .catch(err => [err, null]);
}

const maxConnection = Infinity;
const maxRetry = 3;
let connection = 0;
let queue = [];


const closeConnection = () => {
    connection--;

    if (queue.length > 0 && connection < maxConnection) {
        let next = queue.pop();
        if (typeof next === "function") {
            next();
        }
    }

    return true;
}

const makeRequest = opts => {
    // Â∑•‰ΩúÊéíÁ®ã && ÈáçÂÇ≥
    if (connection >= maxConnection) {
        queue.push(opts); // ??
    } else {
        connection++;
        const xhr = new XMLHttpRequest();
        // xhr.responseType = "arraybuffer";
        if (opts.responseType === "arraybuffer") {
            xhr.responseType = "arraybuffer";
        }
        return new Promise((resolve, reject) => {
            xhr.onreadystatechange = () => {
                // only run if the request is complete
                if (xhr.readyState !== 4) return;
                if (xhr.status >= 200 && xhr.status < 300) {
                    // If successful
                    closeConnection();
                    opts.responseType === "arraybuffer" ?
                        resolve(new Uint8Array(xhr.response)) :
                        resolve(JSON.parse(xhr.responseText));
                } else {
                    // If false  
                    closeConnection();
                    reject(xhr.response);
                }
            }
            // Setup HTTP request
            xhr.open(opts.method || "GET", opts.url, true);
            if (opts.headers) {
                Object.keys(opts.headers).forEach(key => xhr.setRequestHeader(key, opts.headers[key]));
            }
            // Send the request
            if (opts.contentType === 'application/json') {
                xhr.setRequestHeader('content-type', 'application/json');
                xhr.send(JSON.stringify(opts.payload)); //++
            } else {
                xhr.send(opts.payload); //++
            }
        });
    }
}

const renderPin = (parentEl, posX, posY) => {
    let pin = document.querySelector(`.pin`);
    pin ? pin.remove() : null;
    const markup = `<div class="pin"></div>`;
    parentEl.insertAdjacentHTML("afterbegin", markup);
    pin = document.querySelector(`.pin`);
    pin.style.left = `${posX}px`;
    pin.style.top = `${posY}px`;
}


const switchIcon = (iconMarker) => {
    // console.log(iconMarker);
    let iconUrl = iconMarker.options.type;
    // if (iconMarker) {
    //     iconUrl = iconMarker.options.iconMarker.options.iconUrl;
    //     iconUrl = iconUrl.replace("assets/img/icons/", "");
    //     iconUrl = iconUrl.replace(".png", "");
    // }
    // iconMarker.options.type
    // switch (iconUrl) {
    switch (iconMarker.options.type) {
        case "Factory":
            // if(!iconMarker.options.isSelected){
            //     iconMarker.setIcon(factoryIcon);
            //     document.querySelector(`[data-id='${iconMarker.options.id}']`).style.color = "yellow";
            // }else{
            //     iconMarker.setIcon(selectedFactoryIcon);
            //     document.querySelector(`[data-id='${iconMarker.options.id}']`).style.color = "white";
            // }
            !iconMarker.options.isSelected ? iconMarker.setIcon(factoryIcon) : iconMarker.setIcon(selectedFactoryIcon);
            break;
        case "Construction":
            !iconMarker.options.isSelected ? iconMarker.setIcon(constructionIcon) : iconMarker.setIcon(selectedConstructionIcon);
            break;
        case "Restaurant":
            !iconMarker.options.isSelected ? iconMarker.setIcon(restaurantIcon) : iconMarker.setIcon(selectedRestaurantIcon);
            break;
        case "Transportation":
            !iconMarker.options.isSelected ? iconMarker.setIcon(cameraIcon) : iconMarker.setIcon(selectedCameraIcon);
            iconUrl = "Transportation"; // ++
            break;
            // case "Factory_selected":
            //     iconMarker.setIcon(factoryIcon);
            //     break;
            // case "Construction_selected":
            //     iconMarker.setIcon(constructionIcon);
            //     break;
            // case "Restaurant_selected":
            //     iconMarker.setIcon(restaurantIcon);
            //     break;
            // case "Camera_selected":
            //     iconMarker.setIcon(cameraIcon);
            //     break;
        default:
    }
    return iconUrl;
}

function getClickPosition(e, parentEl) {
    var posX = e.clientX;
    var posY = e.clientY;
    // console.log(posX, posY, parentEl);
    renderPin(parentEl, posX, posY);
}

//=================================================================================
// coordinate_transform
const a = 6378137.0; //Âú∞ÁêÉËµ§ÈÅìÂçäÂæë(Equatorial Radius)
const b = 6356752.3142451; //ÂÖ©Ê•µÂçäÂæë(Polar Radius)
let lon0 = 121 * Math.PI / 180; //‰∏≠Â§ÆÁ∂ìÁ∑öÂºßÂ∫¶
let k0 = 0.9999; //‰∏≠Â§ÆÁ∂ìÁ∑öÂ∞∫Â∫¶ÊØî„ÄÇÂú®TMÊäïÂΩ±‰∏≠Â∏∏Áî®ÁöÑÂ∏∂ÂØ¨ÊòØ2Â∫¶Ôºå3Â∫¶Ôºå6Â∫¶„ÄÇÂ∞∫Â∫¶ÊØî‰∏ÄËà¨Ë¶èÂÆöÔºö2Â∫¶ 0.9999„ÄÅ3Â∫¶ 1.0000„ÄÅ6Â∫¶ 0.9996
let dx = 250000;
let dy = 0;
let e = 1 - Math.pow(b, 2) / Math.pow(a, 2);
let e2 = (1 - Math.pow(b, 2) / Math.pow(a, 2)) / (Math.pow(b, 2) / Math.pow(a, 2));

//‰æÜÊ∫êÔºö http://sask989.blogspot.com/2012/05/wgs84totwd97.html
// üëÜ‰ªñÂèÉËÄÉÁöÑÊòØÔºö http://wangshifuola.blogspot.com/2010/08/twd97wgs84-wgs84twd97.html
//Áµ¶WGS84Á∂ìÁ∑ØÂ∫¶Â∫¶ÂàÜÁßíËΩâÊàêTWD97ÂùêÊ®ô
function lonlat_To_twd97(lonD, lonM, lonS, latD, latM, latS) {
    let RadianLon = (lonD) + lonM / 60 + lonS / 3600;
    let RadianLat = (latD) + latM / 60 + latS / 3600;
    return Cal_lonlat_To_twd97(RadianLon, RadianLat);
}

//Áµ¶WGS84Á∂ìÁ∑ØÂ∫¶ÂºßÂ∫¶ËΩâÊàêTWD97ÂùêÊ®ô
function lonlat_To_twd97(RadianLon, RadianLat) {
    return Cal_lonlat_To_twd97(RadianLon, RadianLat);
}

//Áµ¶TWD97ÂùêÊ®ô ËΩâÊàê WGS84 Â∫¶ÂàÜÁßíÂ≠ó‰∏≤ (type1ÂÇ≥Â∫¶ÂàÜÁßí 2ÂÇ≥ÂºßÂ∫¶)
function TWD97_To_lonlat(XValue, YValue, Type) {

    let lonlat = "";

    if (Type == 1) {
        let Answer = Cal_TWD97_To_lonlat(XValue, YValue).Split(',');
        let LonDValue = double.Parse(Answer[0]);
        let LonMValue = ((double.Parse(Answer[0]) - LonDValue) * 60);
        let LonSValue = (((double.Parse(Answer[0]) - LonDValue) * 60) - LonMValue) * 60;

        let LatDValue = double.Parse(Answer[1]);
        let LatMValue = ((double.Parse(Answer[1]) - LatDValue) * 60);
        let LatSValue = (((double.Parse(Answer[1]) - LatDValue) * 60) - LatMValue) * 60;

        lonlat = LonDValue + "Â∫¶" + LonMValue + "ÂàÜ" + LonSValue + "Áßí," + LatDValue + "Â∫¶" + LatMValue + "ÂàÜ" + LatSValue + "Áßí,";
    } else if (Type == 2) {
        lonlat = Cal_TWD97_To_lonlat(XValue, YValue);
    }

    return lonlat;
}

function Cal_lonlat_To_twd97(lon, lat) {
    let TWD97 = "";

    lon = (lon - Math.floor((lon + 180) / 360) * 360) * Math.PI / 180;
    lat = lat * Math.PI / 180;

    let V = a / Math.sqrt(1 - e * Math.pow(Math.sin(lat), 2));
    let T = Math.pow(Math.tan(lat), 2);
    let C = e2 * Math.pow(Math.cos(lat), 2);
    let A = Math.cos(lat) * (lon - lon0);
    let M = a * ((1.0 - e / 4.0 - 3.0 * Math.pow(e, 2) / 64.0 - 5.0 * Math.pow(e, 3) / 256.0) * lat -
        (3.0 * e / 8.0 + 3.0 * Math.pow(e, 2) / 32.0 + 45.0 * Math.pow(e, 3) / 1024.0) *
        Math.sin(2.0 * lat) + (15.0 * Math.pow(e, 2) / 256.0 + 45.0 * Math.pow(e, 3) / 1024.0) *
        Math.sin(4.0 * lat) - (35.0 * Math.pow(e, 3) / 3072.0) * Math.sin(6.0 * lat));
    // x
    let x = dx + k0 * V * (A + (1 - T + C) * Math.pow(A, 3) / 6 + (5 - 18 * T + Math.pow(T, 2) + 72 * C - 58 * e2) * Math.pow(A, 5) / 120);
    // y
    let y = dy + k0 * (M + V * Math.tan(lat) * (Math.pow(A, 2) / 2 + (5 - T + 9 * C + 4 * Math.pow(C, 2)) * Math.pow(A, 4) / 24 + (61 - 58 * T + Math.pow(T, 2) + 600 * C - 330 * e2) * Math.pow(A, 6) / 720));

    TWD97 = x.toString() + "," + y.toString();
    return TWD97;
}

function Cal_TWD97_To_lonlat(x, y) {
    x -= dx;
    y -= dy;

    // Calculate the Meridional Arc
    let M = y / k0;

    // Calculate Footprint Latitude
    let mu = M / (a * (1.0 - e / 4.0 - 3 * Math.pow(e, 2) / 64.0 - 5 * Math.pow(e, 3) / 256.0));
    let e1 = (1.0 - Math.sqrt(1.0 - e)) / (1.0 + Math.sqrt(1.0 - e));

    let J1 = (3 * e1 / 2 - 27 * Math.pow(e1, 3) / 32.0);
    let J2 = (21 * Math.pow(e1, 2) / 16 - 55 * Math.pow(e1, 4) / 32.0);
    let J3 = (151 * Math.pow(e1, 3) / 96.0);
    let J4 = (1097 * Math.pow(e1, 4) / 512.0);

    let fp = mu + J1 * Math.sin(2 * mu) + J2 * Math.sin(4 * mu) + J3 * Math.sin(6 * mu) + J4 * Math.sin(8 * mu);

    // Calculate Latitude and Longitude
    let C1 = e2 * Math.pow(Math.cos(fp), 2);
    let T1 = Math.pow(Math.tan(fp), 2);
    let R1 = a * (1 - e) / Math.pow((1 - e * Math.pow(Math.sin(fp), 2)), (3.0 / 2.0));
    let N1 = a / Math.pow((1 - e * Math.pow(Math.sin(fp), 2)), 0.5);

    let D = x / (N1 * k0);

    // Ë®àÁÆóÁ∑ØÂ∫¶
    let Q1 = N1 * Math.tan(fp) / R1;
    let Q2 = (Math.pow(D, 2) / 2.0);
    let Q3 = (5 + 3 * T1 + 10 * C1 - 4 * Math.pow(C1, 2) - 9 * e2) * Math.pow(D, 4) / 24.0;
    let Q4 = (61 + 90 * T1 + 298 * C1 + 45 * Math.pow(T1, 2) - 3 * Math.pow(C1, 2) - 252 * e2) * Math.pow(D, 6) / 720.0;
    let lat = fp - Q1 * (Q2 - Q3 + Q4);

    // Ë®àÁÆóÁ∂ìÂ∫¶
    let Q5 = D;
    let Q6 = (1 + 2 * T1 + C1) * Math.pow(D, 3) / 6;
    let Q7 = (5 - 2 * C1 + 28 * T1 - 3 * Math.pow(C1, 2) + 8 * e2 + 24 * Math.pow(T1, 2)) * Math.pow(D, 5) / 120.0;
    let lon = lon0 + (Q5 - Q6 + Q7) / Math.cos(fp);

    lat = (lat * 180) / Math.PI; //Á∑ØÂ∫¶
    lon = (lon * 180) / Math.PI; //Á∂ìÂ∫¶

    let lonlat = lon + "," + lat;
    let latlng = [lat, lon];
    return latlng;
}